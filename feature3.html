<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature 3 â€“ Personalized Recommendations & Wellness</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="assets/js/db-crud-operations.js"></script>
  <script src="assets/js/dummy-data.js"></script>
  <script src="assets/js/designation-features-mapping.js"></script>
  <script src="assets/js/designation-data-tables.js"></script>
</head>

<body>
  <!-- Top Navigation -->
  <nav class="top-navbar">
    <div class="nav-container">
      <a href="./index.html" class="nav-logo">ğŸ§  Hermony AI</a>
      <ul class="nav-menu">
        <li><a href="./index.html">ğŸ  Dashboard</a></li>
        <li><a href="./feature1.html">ğŸ“‹ Mood Logging</a></li>
        <li><a href="./feature2.html">ğŸ‘¨â€âš•ï¸ Counsellors</a></li>
        <li><a href="./feature3.html">ğŸ§˜ Recommendations</a></li>
        <li><a href="./feature4.html">â­ Feedback</a></li>
        <li><a href="./feature5.html">ğŸ¤– AI Analysis</a></li>
        <li><a href="./feature6.html">ğŸ‘¤ Profiles</a></li>
      </ul>
      <div class="nav-actions">
        <button class="mobile-menu-btn" aria-label="Toggle menu" title="Open navigation">
          <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
            focusable="false">
            <rect x="3" y="6" width="18" height="2" rx="1" fill="currentColor" />
            <rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor" />
            <rect x="3" y="16" width="18" height="2" rx="1" fill="currentColor" />
          </svg>
        </button>
        <button class="theme-toggle" title="Toggle dark mode">ğŸŒ™</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <h2>Personalized Wellness Recommendations</h2>
    <p>Create and manage personalized wellness tips and activities linked to user data for guided mental health
      improvement.</p>

    <!-- RECOMMENDATIONS FORM SECTION -->
    <section
      style="margin-top: 3rem; background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
      <h3>Create New Recommendation</h3>
      <form id="recommendationForm">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">User ID</label>
            <input type="number" class="form-control" id="recUserId" placeholder="Enter user ID" required>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Category</label>
            <select class="form-control" id="recCategory" required>
              <option value="">-- Select Category --</option>
              <option value="Meditation">ğŸ§˜ Meditation</option>
              <option value="Exercise">ğŸ’ª Exercise</option>
              <option value="Sleep">ğŸ˜´ Sleep Hygiene</option>
              <option value="Nutrition">ğŸ¥— Nutrition</option>
              <option value="Social">ğŸ‘¥ Social Connection</option>
              <option value="Journaling">ğŸ“ Journaling</option>
              <option value="Breathing">ğŸŒ¬ï¸ Breathing Techniques</option>
              <option value="Creative">ğŸ¨ Creative Activities</option>
              <option value="Mindfulness">ğŸŒ¿ Mindfulness</option>
              <option value="Other">ğŸ“Œ Other</option>
            </select>
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">Priority Level</label>
            <select class="form-control" id="recPriority" required>
              <option value="High">ğŸ”´ High Priority</option>
              <option value="Medium">ğŸŸ¡ Medium Priority</option>
              <option value="Low">ğŸŸ¢ Low Priority</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Wellness Tip / Activity</label>
          <textarea class="form-control" id="recTip" rows="3"
            placeholder="Describe the wellness tip or activity recommendation..." required></textarea>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Duration / Frequency</label>
            <input type="text" class="form-control" id="recDuration" placeholder="e.g., 30 min daily, 3x per week">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Expected Benefits</label>
            <input type="text" class="form-control" id="recBenefits"
              placeholder="e.g., Improved sleep, Reduced anxiety">
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Detailed Guidance (Optional)</label>
          <textarea class="form-control" id="recGuidance" rows="3"
            placeholder="Provide step-by-step instructions or additional details..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary">âœ¨ Create Recommendation</button>
        <button type="reset" class="btn btn-secondary">Clear Form</button>
      </form>
    </section>

    <!-- RECOMMENDATIONS ANALYTICS SECTION -->
    <section style="margin-top: 3rem;">
      <h3>Recommendation Analytics</h3>
      <div class="row">
        <div class="col-md-6">
          <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h5>Recommendations by Category</h5>
            <canvas id="categoryChart" height="80"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <h5>Recommendations Statistics</h5>
            <div class="rec-stats">
              <div class="stat-item">
                <span class="stat-label">Total Recommendations</span>
                <span class="stat-value" id="totalRecs">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">High Priority</span>
                <span class="stat-value" id="highPriorityCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Active Users</span>
                <span class="stat-value" id="activeUsersCount">0</span>
              </div>
              <div class="stat-item">
                <span class="stat-label">Most Common</span>
                <span class="stat-value" id="mostCommonCategory">--</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RECOMMENDATIONS TABLE SECTION -->
    <section style="margin-top: 3rem;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>All Wellness Recommendations</h3>
        <input type="text" id="searchRecommendations" class="form-control w-50"
          placeholder="ğŸ” Search by user ID, category, or tip">
      </div>

      <div class="table-responsive">
        <table class="table table-hover" id="recommendationsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>User ID</th>
              <th>Category</th>
              <th>Wellness Tip</th>
              <th>Duration</th>
              <th>Priority</th>
              <th>Benefits</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Data will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- View Recommendation Modal -->
    <div class="modal fade" id="viewRecommendationModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Recommendation Details</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="recommendationDetailsContent">
            <!-- Content will be populated by JavaScript -->
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    </main>
  </div>

  <script>

    // ===== POPULATE RECOMMENDATIONS TABLE =====
    async function populateRecommendationsTable() {
      try {
        const recommendations = await window.DailyDB.getAllRecommendations();
        const tbody = document.querySelector('#recommendationsTable tbody');
        tbody.innerHTML = '';

        if (recommendations.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No recommendations yet</td></tr>';
          return;
        }

        // Sort by priority and date
        recommendations.sort((a, b) => {
          const priorityOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
          return priorityOrder[a.priority] - priorityOrder[b.priority];
        });

        recommendations.forEach(rec => {
          const row = document.createElement('tr');
          const priorityEmoji = {
            'High': 'ğŸ”´',
            'Medium': 'ğŸŸ¡',
            'Low': 'ğŸŸ¢'
          }[rec.priority] || 'âšª';

          row.innerHTML = `
            <td><strong>${rec.id}</strong></td>
            <td><strong>U${rec.userId}</strong></td>
            <td><span class="badge bg-info">${rec.category}</span></td>
            <td><small>${rec.tip.substring(0, 40)}...</small></td>
            <td><small>${rec.duration || '--'}</small></td>
            <td>${priorityEmoji} ${rec.priority}</td>
            <td><small>${rec.benefits || '--'}</small></td>
            <td>
              <button class="btn btn-sm btn-info viewRecBtn" data-id="${rec.id}">ğŸ‘ï¸ View</button>
              <button class="btn btn-sm btn-danger deleteRecBtn" data-id="${rec.id}">ğŸ—‘ï¸ Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });

        // Update analytics
        updateRecommendationStats(recommendations);
        initializeCategoryChart(recommendations);
      } catch (err) {
        console.error('Error loading recommendations:', err);
      }
    }

    // ===== SUBMIT RECOMMENDATION FORM =====
    document.getElementById('recommendationForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const recommendation = {
        userId: parseInt(document.getElementById('recUserId').value),
        category: document.getElementById('recCategory').value,
        priority: document.getElementById('recPriority').value,
        tip: document.getElementById('recTip').value,
        duration: document.getElementById('recDuration').value,
        benefits: document.getElementById('recBenefits').value,
        guidance: document.getElementById('recGuidance').value,
        timestamp: new Date().toISOString(),
        createdDate: new Date().toISOString().split('T')[0]
      };

      try {
        await window.DailyDB.addRecommendation(recommendation);
        alert('âœ… Recommendation created successfully!');
        document.getElementById('recommendationForm').reset();
        await populateRecommendationsTable();
      } catch (err) {
        alert('âŒ Error creating recommendation: ' + err.message);
      }
    });

    // ===== VIEW RECOMMENDATION =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('viewRecBtn')) {
        const recId = e.target.getAttribute('data-id');
        const recommendations = await window.DailyDB.getAllRecommendations();
        const rec = recommendations.find(r => r.id === parseInt(recId));

        if (rec) {
          const priorityEmoji = { 'High': 'ğŸ”´', 'Medium': 'ğŸŸ¡', 'Low': 'ğŸŸ¢' }[rec.priority];
          const categoryEmojis = {
            'Meditation': 'ğŸ§˜',
            'Exercise': 'ğŸ’ª',
            'Sleep': 'ğŸ˜´',
            'Nutrition': 'ğŸ¥—',
            'Social': 'ğŸ‘¥',
            'Journaling': 'ğŸ“',
            'Breathing': 'ğŸŒ¬ï¸',
            'Creative': 'ğŸ¨',
            'Mindfulness': 'ğŸŒ¿',
            'Other': 'ğŸ“Œ'
          };
          const emoji = categoryEmojis[rec.category] || 'ğŸ“Œ';

          const content = `
            <p><strong>Recommendation ID:</strong> ${rec.id}</p>
            <p><strong>User ID:</strong> U${rec.userId}</p>
            <p><strong>Category:</strong> ${emoji} ${rec.category}</p>
            <p><strong>Priority:</strong> ${priorityEmoji} ${rec.priority} Priority</p>
            <p><strong>Wellness Tip / Activity:</strong></p>
            <div class="alert alert-info">${rec.tip}</div>
            <p><strong>Duration / Frequency:</strong> ${rec.duration || 'Not specified'}</p>
            <p><strong>Expected Benefits:</strong> ${rec.benefits || 'Not specified'}</p>
            ${rec.guidance ? `
              <p><strong>Detailed Guidance:</strong></p>
              <div class="alert alert-success">${rec.guidance}</div>
            ` : ''}
            <p><strong>Created:</strong> ${new Date(rec.timestamp).toLocaleString()}</p>
          `;
          document.getElementById('recommendationDetailsContent').innerHTML = content;
          const modal = new bootstrap.Modal(document.getElementById('viewRecommendationModal'));
          modal.show();
        }
      }
    });

    // ===== DELETE RECOMMENDATION =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('deleteRecBtn')) {
        const recId = e.target.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this recommendation?')) {
          try {
            await window.DailyDB.deleteRecommendation(recId);
            alert('âœ… Recommendation deleted successfully!');
            await populateRecommendationsTable();
          } catch (err) {
            alert('âŒ Error deleting recommendation: ' + err.message);
          }
        }
      }
    });

    // ===== SEARCH RECOMMENDATIONS =====
    document.getElementById('searchRecommendations').addEventListener('keyup', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('#recommendationsTable tbody tr').forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      });
    });

    // ===== UPDATE RECOMMENDATION STATISTICS =====
    function updateRecommendationStats(recommendations) {
      document.getElementById('totalRecs').textContent = recommendations.length;

      const highCount = recommendations.filter(r => r.priority === 'High').length;
      document.getElementById('highPriorityCount').textContent = highCount;

      const uniqueUsers = new Set(recommendations.map(r => r.userId)).size;
      document.getElementById('activeUsersCount').textContent = uniqueUsers;

      const categoryCount = {};
      recommendations.forEach(r => {
        categoryCount[r.category] = (categoryCount[r.category] || 0) + 1;
      });

      const mostCommon = Object.keys(categoryCount).reduce((a, b) =>
        categoryCount[a] > categoryCount[b] ? a : b, 'None');
      document.getElementById('mostCommonCategory').textContent = mostCommon;
    }

    // ===== CATEGORY CHART INITIALIZATION =====
    let categoryChartInstance = null;

    function initializeCategoryChart(recommendations) {
      const categoryCount = {};
      recommendations.forEach(rec => {
        categoryCount[rec.category] = (categoryCount[rec.category] || 0) + 1;
      });

      const categories = Object.keys(categoryCount);
      const counts = Object.values(categoryCount);
      const colors = ['#667eea', '#764ba2', '#1abc9c', '#f39c12', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#34495e', '#e67e22'];

      const ctx = document.getElementById('categoryChart').getContext('2d');
      if (categoryChartInstance) categoryChartInstance.destroy();

      categoryChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: categories,
          datasets: [{
            data: counts,
            backgroundColor: colors.slice(0, categories.length),
            borderColor: '#fff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              display: true,
              position: 'bottom'
            }
          }
        }
      });
    }

    // ===== ROLE-BASED DATA DISPLAY =====
    async function displayRoleData() {
      const userRole = localStorage.getItem('userRole') || 'patient';
      const designation = localStorage.getItem('designation') || 'Patient/User';

      if (userRole === 'patient') return;

      const mainContent = document.querySelector('.main-content');
      const roleDataSection = document.createElement('section');
      roleDataSection.id = 'roleDataSection';
      roleDataSection.style.cssText = 'margin-top: 3rem; border-top: 2px solid #ddd; padding-top: 2rem;';

      const heading = document.createElement('h3');
      heading.textContent = 'ğŸ“Š ' + designation + ' Dashboard - Data Overview';
      heading.style.marginBottom = '2rem';
      roleDataSection.appendChild(heading);

      const contentDiv = document.createElement('div');
      contentDiv.id = 'roleDataContent';
      roleDataSection.appendChild(contentDiv);
      mainContent.appendChild(roleDataSection);

      try {
        await window.ComprehensiveSeedData.initializeAllSeedData();

        let html = '';
        if (userRole === 'software_engineer') {
          html += await window.DesignationDataTables.getSoftwareEngineerTable();
        } else if (userRole === 'ai_engineer') {
          html += await window.DesignationDataTables.getAIEngineerTable();
        } else if (userRole === 'data_scientist') {
          html += await window.DesignationDataTables.getDataScientistTable();
        } else if (userRole === 'mental_health_admin') {
          html += await window.DesignationDataTables.getMentalHealthAdminTable();
        } else if (userRole === 'emergency_team') {
          html += await window.DesignationDataTables.getEmergencyTeamTable();
        } else if (userRole === 'security_analyst') {
          html += await window.DesignationDataTables.getSecurityAnalystTable();
        } else if (userRole === 'financial_team') {
          html += await window.DesignationDataTables.getFinancialTeamTable();
        } else if (userRole === 'system_admin') {
          html += await window.DesignationDataTables.getSystemAdminTable();
        }
        contentDiv.innerHTML = html;
      } catch (error) {
        console.error('Error displaying role data:', error);
        contentDiv.innerHTML = '<p style="color: red;">Error loading data. Check console for details.</p>';
      }
    }

    // ===== INITIALIZE =====
    document.addEventListener('DOMContentLoaded', async () => {
      await populateRecommendationsTable();
      displayRoleData();

      // Add test helper
      window.testData = async function (role) {
        console.log('ğŸ§ª Testing role:', role);
        localStorage.setItem('userRole', role);
        localStorage.setItem('designation', role.replace(/_/g, ' ').toUpperCase());
        await displayRoleData();
      };
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/theme.js"></script>
</body>

</html>