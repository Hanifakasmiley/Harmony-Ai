<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Harmony AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .table-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .table-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .table-tab:hover {
            background: var(--bg-tertiary);
        }

        .table-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .data-section {
            background: var(--bg-primary);
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            overflow-x: auto;
        }

        .data-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background: var(--bg-tertiary);
        }

        .btn-crud {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            margin-right: 0.25rem;
        }

        .btn-edit {
            background: #4facfe;
            color: white;
            border: none;
        }

        .btn-delete {
            background: #ff6b6b;
            color: white;
            border: none;
        }

        .modal-content {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .modal-header {
            border-bottom-color: var(--border-color);
        }

        .modal-footer {
            border-top-color: var(--border-color);
        }

        .form-control,
        .form-select {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .form-control:focus,
        .form-select:focus {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: #667eea;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .stat-box .label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="top-navbar">
        <div class="nav-container">
            <a href="./index.html" class="nav-logo">üß† Harmony AI</a>
            <ul class="nav-menu">
                <li><a href="./dashboard.html">üìä Dashboard</a></li>
                <li><a href="./admin.html" class="active">‚öôÔ∏è Admin</a></li>
                <li><a href="./feature-daily-logs.html">üìù Daily Logs</a></li>
                <li><a href="./feature-sessions.html">üë®‚Äç‚öïÔ∏è Sessions</a></li>
                <li><a href="./feature-crisis.html">üö® Crisis</a></li>
            </ul>
            <div class="nav-actions">
                <button class="theme-toggle" type="button" aria-label="Toggle theme"></button>
                <button class="mobile-menu-btn" aria-label="Toggle menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="6" width="18" height="2" rx="1" fill="currentColor" />
                        <rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor" />
                        <rect x="3" y="16" width="18" height="2" rx="1" fill="currentColor" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="admin-header">
            <h1 style="margin: 0;">‚öôÔ∏è Database Admin Panel</h1>
            <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Manage all 10 database tables with CRUD operations</p>
        </div>

        <!-- Stats Row -->
        <div class="stats-row" id="statsRow">
            <div class="stat-box">
                <div class="number" id="statUsers">-</div>
                <div class="label">Users</div>
            </div>
            <div class="stat-box">
                <div class="number" id="statLogs">-</div>
                <div class="label">Daily Logs</div>
            </div>
            <div class="stat-box">
                <div class="number" id="statCounsellors">-</div>
                <div class="label">Counsellors</div>
            </div>
            <div class="stat-box">
                <div class="number" id="statSessions">-</div>
                <div class="label">Sessions</div>
            </div>
            <div class="stat-box">
                <div class="number" id="statAlerts">-</div>
                <div class="label">Crisis Alerts</div>
            </div>
        </div>

        <!-- Table Tabs -->
        <div class="table-tabs">
            <button class="table-tab active" data-table="users">üë• Users</button>
            <button class="table-tab" data-table="dailylogs">üìù Daily Logs</button>
            <button class="table-tab" data-table="counsellors">üë®‚Äç‚öïÔ∏è Counsellors</button>
            <button class="table-tab" data-table="sessions">üìÖ Sessions</button>
            <button class="table-tab" data-table="feedback">üí¨ Feedback</button>
            <button class="table-tab" data-table="progress">üìà Progress</button>
            <button class="table-tab" data-table="recommendations">üí° Recommendations</button>
            <button class="table-tab" data-table="ai_analysis">ü§ñ AI Analysis</button>
            <button class="table-tab" data-table="crisisalerts">üö® Crisis Alerts</button>
            <button class="table-tab" data-table="emergencycontacts">üìû Emergency Contacts</button>
        </div>

        <!-- Data Section -->
        <div class="data-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 id="tableTitle" style="margin: 0;">üë• Users</h3>
                <button class="btn btn-primary" onclick="openCreateModal()">‚ûï Add New</button>
            </div>
            <div class="data-table" id="dataTableContainer">
                <div class="loading">Loading data...</div>
            </div>
        </div>
    </div>

    <!-- CRUD Modal -->
    <div class="modal fade" id="crudModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crudForm"></form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecord()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api-service.js"></script>
    <script src="assets/js/theme.js"></script>

    <script>
        let currentTable = 'users';
        let currentData = [];
        let editingId = null;
        let crudModal;

        // Table schemas for form generation
        const tableSchemas = {
            users: {
                title: 'üë• Users',
                idField: 'user_id',
                fields: [
                    { name: 'full_name', label: 'Full Name', type: 'text', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'password', label: 'Password', type: 'password', required: false },
                    { name: 'phone', label: 'Phone', type: 'text' },
                    { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other'] },
                    { name: 'date_of_birth', label: 'Date of Birth', type: 'date' },
                    { name: 'designation', label: 'Designation', type: 'select', options: ['Patient/User', 'Data Scientist', 'System Administrator', 'Software Engineer', 'Mental Health Administrator', 'Emergency Contact Team'] },
                    { name: 'preferences', label: 'Preferences', type: 'textarea' }
                ]
            },
            dailylogs: {
                title: 'üìù Daily Logs',
                idField: 'log_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'mood_level', label: 'Mood Level', type: 'select', options: ['Happy', 'Sad', 'Anxious', 'Calm', 'Energetic', 'Tired', 'Neutral', 'Stressed'] },
                    { name: 'stress_level', label: 'Stress Level (1-10)', type: 'number' },
                    { name: 'sleep_hours', label: 'Sleep Hours', type: 'number' },
                    { name: 'notes', label: 'Notes', type: 'textarea' },
                    { name: 'log_date', label: 'Log Date', type: 'date' }
                ]
            },
            counsellors: {
                title: 'üë®‚Äç‚öïÔ∏è Counsellors',
                idField: 'counsellor_id',
                fields: [
                    { name: 'name', label: 'Name', type: 'text', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'phone', label: 'Phone', type: 'text' },
                    { name: 'specialization', label: 'Specialization', type: 'text' },
                    { name: 'schedule', label: 'Schedule', type: 'text' }
                ]
            },
            sessions: {
                title: 'üìÖ Sessions',
                idField: 'session_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'counsellor_id', label: 'Counsellor ID', type: 'number', required: true },
                    { name: 'session_time', label: 'Session Time', type: 'datetime-local' },
                    { name: 'session_notes', label: 'Session Notes', type: 'textarea' },
                    { name: 'feedback', label: 'Feedback', type: 'textarea' }
                ]
            },
            feedback: {
                title: 'üí¨ Feedback',
                idField: 'feedback_id',
                fields: [
                    { name: 'session_id', label: 'Session ID', type: 'number', required: true },
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'rating', label: 'Rating (1-5)', type: 'number' },
                    { name: 'comments', label: 'Comments', type: 'textarea' }
                ]
            },
            progress: {
                title: 'üìà Progress',
                idField: 'progress_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'emotional_stability_score', label: 'Emotional Stability Score', type: 'number' },
                    { name: 'improvement_percentage', label: 'Improvement %', type: 'number' },
                    { name: 'trend_notes', label: 'Trend Notes', type: 'textarea' }
                ]
            },
            recommendations: {
                title: 'üí° Recommendations',
                idField: 'rec_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'wellness_tip', label: 'Wellness Tip', type: 'textarea' },
                    { name: 'activity', label: 'Activity', type: 'text' }
                ]
            },
            ai_analysis: {
                title: 'ü§ñ AI Analysis',
                idField: 'analysis_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'risk_score', label: 'Risk Score (0-100)', type: 'number' },
                    { name: 'sentiment_value', label: 'Sentiment Value', type: 'number' },
                    { name: 'emotion_label', label: 'Emotion Label', type: 'select', options: ['Anxiety', 'Depression', 'Stress', 'Burnout', 'Stability', 'Optimism'] }
                ]
            },
            crisisalerts: {
                title: 'üö® Crisis Alerts',
                idField: 'alert_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'risk_level', label: 'Risk Level', type: 'select', options: ['Low', 'Medium', 'High', 'Critical'] },
                    { name: 'alert_timestamp', label: 'Alert Timestamp', type: 'datetime-local' },
                    { name: 'contacted_counsellor_id', label: 'Contacted Counsellor ID', type: 'number' }
                ]
            },
            emergencycontacts: {
                title: 'üìû Emergency Contacts',
                idField: 'contact_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'contact_name', label: 'Contact Name', type: 'text', required: true },
                    { name: 'contact_phone', label: 'Contact Phone', type: 'text', required: true },
                    { name: 'relation', label: 'Relation', type: 'text' }
                ]
            }
        };

        // API endpoints mapping
        const apiEndpoints = {
            users: { get: ApiService.getUsers, create: (d) => ApiService.register(d), update: ApiService.updateUser, delete: ApiService.deleteUser },
            dailylogs: { get: ApiService.getDailyLogs, create: ApiService.createDailyLog, update: ApiService.updateDailyLog, delete: ApiService.deleteDailyLog },
            counsellors: { get: ApiService.getCounsellors, create: ApiService.createCounsellor, update: ApiService.updateCounsellor, delete: ApiService.deleteCounsellor },
            sessions: { get: ApiService.getSessions, create: ApiService.createSession, update: ApiService.updateSession, delete: ApiService.deleteSession },
            feedback: { get: ApiService.getFeedback, create: ApiService.createFeedback, update: ApiService.updateFeedback, delete: ApiService.deleteFeedback },
            progress: { get: ApiService.getProgress, create: ApiService.createProgress, update: ApiService.updateProgress, delete: ApiService.deleteProgress },
            recommendations: { get: ApiService.getRecommendations, create: ApiService.createRecommendation, update: ApiService.updateRecommendation, delete: ApiService.deleteRecommendation },
            ai_analysis: { get: ApiService.getAIAnalysis, create: ApiService.createAIAnalysis, update: ApiService.updateAIAnalysis, delete: ApiService.deleteAIAnalysis },
            crisisalerts: { get: ApiService.getCrisisAlerts, create: ApiService.createCrisisAlert, update: ApiService.updateCrisisAlert, delete: ApiService.deleteCrisisAlert },
            emergencycontacts: { get: ApiService.getEmergencyContacts, create: ApiService.createEmergencyContact, update: ApiService.updateEmergencyContact, delete: ApiService.deleteEmergencyContact }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));
            setupTabs();
            loadStats();
            loadTableData('users');
            setupMobileMenu();
        });

        function setupTabs() {
            document.querySelectorAll('.table-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTable = tab.dataset.table;
                    document.getElementById('tableTitle').textContent = tableSchemas[currentTable].title;
                    loadTableData(currentTable);
                });
            });
        }

        async function loadStats() {
            try {
                const [users, logs, counsellors, sessions, alerts] = await Promise.all([
                    ApiService.getUsers(),
                    ApiService.getDailyLogs(),
                    ApiService.getCounsellors(),
                    ApiService.getSessions(),
                    ApiService.getCrisisAlerts()
                ]);
                document.getElementById('statUsers').textContent = users.length;
                document.getElementById('statLogs').textContent = logs.length;
                document.getElementById('statCounsellors').textContent = counsellors.length;
                document.getElementById('statSessions').textContent = sessions.length;
                document.getElementById('statAlerts').textContent = alerts.length;
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadTableData(table) {
            const container = document.getElementById('dataTableContainer');
            container.innerHTML = '<div class="loading">Loading data...</div>';

            try {
                currentData = await apiEndpoints[table].get();
                renderTable(currentData, table);
            } catch (error) {
                container.innerHTML = `<div class="loading" style="color: #ff6b6b;">Error loading data: ${error.message}</div>`;
            }
        }

        function renderTable(data, table) {
            const schema = tableSchemas[table];
            const container = document.getElementById('dataTableContainer');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="loading">No data found. Click "Add New" to create a record.</div>';
                return;
            }

            const columns = [schema.idField, ...schema.fields.map(f => f.name)];
            let html = '<table><thead><tr>';
            columns.forEach(col => {
                html += `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`;
            });
            html += '<th>ACTIONS</th></tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] || '-';
                    if (col === 'password') value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    if (typeof value === 'string' && value.length > 50) value = value.substring(0, 50) + '...';
                    html += `<td>${value}</td>`;
                });
                const id = row[schema.idField];
                html += `<td>
                    <button class="btn btn-crud btn-edit" onclick="openEditModal(${id})">‚úèÔ∏è Edit</button>
                    <button class="btn btn-crud btn-delete" onclick="deleteRecord(${id})">üóëÔ∏è Delete</button>
                </td></tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = `Add ${tableSchemas[currentTable].title}`;
            generateForm();
            crudModal.show();
        }

        function openEditModal(id) {
            editingId = id;
            const record = currentData.find(r => r[tableSchemas[currentTable].idField] === id);
            document.getElementById('modalTitle').textContent = `Edit ${tableSchemas[currentTable].title}`;
            generateForm(record);
            crudModal.show();
        }

        function generateForm(data = {}) {
            const schema = tableSchemas[currentTable];
            let html = '';

            schema.fields.forEach(field => {
                const value = data[field.name] || '';
                html += `<div class="mb-3">
                    <label class="form-label">${field.label}${field.required ? ' *' : ''}</label>`;

                if (field.type === 'select') {
                    html += `<select class="form-select" name="${field.name}" ${field.required ? 'required' : ''}>
                        <option value="">Select...</option>`;
                    field.options.forEach(opt => {
                        html += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += '</select>';
                } else if (field.type === 'textarea') {
                    html += `<textarea class="form-control" name="${field.name}" rows="3" ${field.required ? 'required' : ''}>${value}</textarea>`;
                } else {
                    html += `<input type="${field.type}" class="form-control" name="${field.name}" value="${value}" ${field.required ? 'required' : ''}>`;
                }
                html += '</div>';
            });

            document.getElementById('crudForm').innerHTML = html;
        }

        async function saveRecord() {
            const form = document.getElementById('crudForm');
            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (value) data[key] = value;
            }

            try {
                if (editingId) {
                    await apiEndpoints[currentTable].update(editingId, data);
                    alert('‚úÖ Record updated successfully!');
                } else {
                    await apiEndpoints[currentTable].create(data);
                    alert('‚úÖ Record created successfully!');
                }
                crudModal.hide();
                loadTableData(currentTable);
                loadStats();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            try {
                await apiEndpoints[currentTable].delete(id);
                alert('‚úÖ Record deleted successfully!');
                loadTableData(currentTable);
                loadStats();
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function setupMobileMenu() {
            const btn = document.querySelector('.mobile-menu-btn');
            const menu = document.querySelector('.nav-menu');
            if (btn && menu) {
                btn.addEventListener('click', () => menu.classList.toggle('active'));
            }
        }
    </script>
</body>

</html>