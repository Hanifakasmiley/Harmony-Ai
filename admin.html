<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Harmony AI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/theme.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 2.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);
        }

        .admin-header h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: white !important;
        }

        .admin-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1rem;
            color: white !important;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: white !important;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .back-link:hover {
            opacity: 1;
            color: white !important;
        }

        /* Mobile Menu Button Fix */
        .mobile-menu-btn {
            display: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--text-primary);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .nav-menu {
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--bg-primary);
                flex-direction: column;
                padding: 1rem;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
                border-top: 1px solid var(--border-color);
            }

            .nav-menu.active {
                display: flex;
            }

            .nav-menu li {
                margin: 0.5rem 0;
            }
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .stat-card {
            background: var(--bg-primary);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }

        .stat-card .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            line-height: 1.2;
        }

        .stat-card .label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Table Tabs */
        .table-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .table-tab {
            padding: 0.75rem 1.25rem;
            border: 2px solid transparent;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-tab:hover {
            background: var(--bg-secondary);
            border-color: #667eea;
            color: #667eea;
        }

        .table-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Data Section */
        .data-section {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--border-color);
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .data-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-add {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        /* Data Table */
        .data-table-wrapper {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0.75rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            vertical-align: middle;
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Action Buttons */
        .action-btns {
            display: flex;
            gap: 0.5rem;
        }

        .btn-edit,
        .btn-delete {
            padding: 0.5rem 0.75rem;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .btn-edit {
            background: #e3f2fd;
            color: #1976d2;
        }

        .btn-edit:hover {
            background: #1976d2;
            color: white;
        }

        .btn-delete {
            background: #ffebee;
            color: #d32f2f;
        }

        .btn-delete:hover {
            background: #d32f2f;
            color: white;
        }

        /* Loading & Empty States */
        .loading-state,
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-state .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .error-state {
            text-align: center;
            padding: 2rem;
            color: #d32f2f;
            background: #ffebee;
            border-radius: 12px;
        }

        /* Modal Improvements */
        .modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px 16px 0 0;
            padding: 1.25rem 1.5rem;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-control,
        .form-select {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s;
        }

        .form-control:focus,
        .form-select:focus {
            background: var(--bg-secondary);
            border-color: #667eea;
            color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        /* Badge for data types */
        .data-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-high {
            background: #ffebee;
            color: #d32f2f;
        }

        .badge-medium {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-low {
            background: #e8f5e9;
            color: #388e3c;
        }

        .badge-info {
            background: #e3f2fd;
            color: #1976d2;
        }

        /* Dark mode specific */
        body.dark-mode .stat-card .number {
            color: #a5b4fc;
        }

        body.dark-mode .btn-edit {
            background: rgba(25, 118, 210, 0.2);
        }

        body.dark-mode .btn-delete {
            background: rgba(211, 47, 47, 0.2);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="top-navbar">
        <div class="nav-container">
            <a href="./index.html" class="nav-logo">üß† Harmony AI</a>
            <ul class="nav-menu">
                <li><a href="./dashboard.html">üìä Dashboard</a></li>
                <li><a href="./admin.html" class="active">‚öôÔ∏è Admin</a></li>
                <li><a href="./feature-daily-logs.html">üìù Logs</a></li>
                <li><a href="./feature-sessions.html">üë®‚Äç‚öïÔ∏è Sessions</a></li>
                <li><a href="./feature-crisis.html">üö® Crisis</a></li>
            </ul>
            <div class="nav-actions">
                <button class="theme-toggle" type="button" aria-label="Toggle theme"></button>
                <button class="mobile-menu-btn" aria-label="Toggle menu">
                    <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="6" width="18" height="2" rx="1" fill="currentColor" />
                        <rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor" />
                        <rect x="3" y="16" width="18" height="2" rx="1" fill="currentColor" />
                    </svg>
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <a href="./dashboard.html" class="back-link">‚Üê Back to Dashboard</a>
            <h1>‚öôÔ∏è Database Admin Panel</h1>
            <p>Manage all 10 database tables with full CRUD operations</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üë•</div>
                <div class="number" id="statUsers">-</div>
                <div class="label">Users</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìù</div>
                <div class="number" id="statLogs">-</div>
                <div class="label">Daily Logs</div>
            </div>
            <div class="stat-card">
                <div class="icon">üë®‚Äç‚öïÔ∏è</div>
                <div class="number" id="statCounsellors">-</div>
                <div class="label">Counsellors</div>
            </div>
            <div class="stat-card">
                <div class="icon">üìÖ</div>
                <div class="number" id="statSessions">-</div>
                <div class="label">Sessions</div>
            </div>
            <div class="stat-card">
                <div class="icon">üö®</div>
                <div class="number" id="statAlerts">-</div>
                <div class="label">Crisis Alerts</div>
            </div>
        </div>

        <!-- Table Tabs -->
        <div class="table-tabs">
            <button class="table-tab active" data-table="users">üë• Users</button>
            <button class="table-tab" data-table="dailylogs">üìù Daily Logs</button>
            <button class="table-tab" data-table="counsellors">üë®‚Äç‚öïÔ∏è Counsellors</button>
            <button class="table-tab" data-table="sessions">üìÖ Sessions</button>
            <button class="table-tab" data-table="feedback">üí¨ Feedback</button>
            <button class="table-tab" data-table="progress">üìà Progress</button>
            <button class="table-tab" data-table="recommendations">üí° Recommendations</button>
            <button class="table-tab" data-table="ai_analysis">ü§ñ AI Analysis</button>
            <button class="table-tab" data-table="crisisalerts">üö® Crisis Alerts</button>
            <button class="table-tab" data-table="emergencycontacts">üìû Emergency Contacts</button>
        </div>

        <!-- Data Section -->
        <div class="data-section">
            <div class="data-header">
                <h2 id="tableTitle">üë• Users</h2>
                <button class="btn-add" onclick="openCreateModal()">‚ûï Add New Record</button>
            </div>
            <div class="data-table-wrapper" id="dataTableContainer">
                <div class="loading-state">
                    <div class="spinner"></div>
                    <p>Loading data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- CRUD Modal -->
    <div class="modal fade" id="crudModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="crudForm"></form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecord()"
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">üíæ Save
                        Record</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/api-service.js"></script>
    <script src="assets/js/theme.js"></script>

    <script>
        let currentTable = 'users';
        let currentData = [];
        let editingId = null;
        let crudModal;

        // Table schemas
        const tableSchemas = {
            users: {
                title: 'üë• Users',
                idField: 'user_id',
                fields: [
                    { name: 'full_name', label: 'Full Name', type: 'text', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'password', label: 'Password', type: 'password', required: false },
                    { name: 'phone', label: 'Phone', type: 'text' },
                    { name: 'gender', label: 'Gender', type: 'select', options: ['Male', 'Female', 'Other', 'Non-Binary'] },
                    { name: 'date_of_birth', label: 'Date of Birth', type: 'date' },
                    { name: 'designation', label: 'Designation', type: 'select', options: ['Patient/User', 'Data Scientist', 'System Administrator', 'Software Engineer', 'Mental Health Administrator', 'Emergency Contact Team'] },
                    { name: 'preferences', label: 'Preferences', type: 'textarea' }
                ]
            },
            dailylogs: {
                title: 'üìù Daily Logs',
                idField: 'log_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'mood_level', label: 'Mood Level', type: 'select', options: ['Happy', 'Sad', 'Anxious', 'Calm', 'Energetic', 'Tired', 'Neutral', 'Stressed', 'Angry'] },
                    { name: 'stress_level', label: 'Stress Level (1-10)', type: 'number' },
                    { name: 'sleep_hours', label: 'Sleep Hours', type: 'number' },
                    { name: 'notes', label: 'Notes', type: 'textarea' },
                    { name: 'log_date', label: 'Log Date', type: 'date' }
                ]
            },
            counsellors: {
                title: 'üë®‚Äç‚öïÔ∏è Counsellors',
                idField: 'counsellor_id',
                fields: [
                    { name: 'name', label: 'Name', type: 'text', required: true },
                    { name: 'email', label: 'Email', type: 'email', required: true },
                    { name: 'phone', label: 'Phone', type: 'text' },
                    { name: 'specialization', label: 'Specialization', type: 'text' },
                    { name: 'schedule', label: 'Schedule', type: 'text' }
                ]
            },
            sessions: {
                title: 'üìÖ Sessions',
                idField: 'session_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'counsellor_id', label: 'Counsellor ID', type: 'number', required: true },
                    { name: 'session_time', label: 'Session Time', type: 'datetime-local' },
                    { name: 'session_notes', label: 'Session Notes', type: 'textarea' },
                    { name: 'feedback', label: 'Feedback', type: 'textarea' }
                ]
            },
            feedback: {
                title: 'üí¨ Feedback',
                idField: 'feedback_id',
                fields: [
                    { name: 'session_id', label: 'Session ID', type: 'number', required: true },
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'rating', label: 'Rating (1-5)', type: 'number' },
                    { name: 'comments', label: 'Comments', type: 'textarea' }
                ]
            },
            progress: {
                title: 'üìà Progress',
                idField: 'progress_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'emotional_stability_score', label: 'Emotional Stability Score (0-100)', type: 'number' },
                    { name: 'improvement_percentage', label: 'Improvement %', type: 'number' },
                    { name: 'trend_notes', label: 'Trend Notes', type: 'textarea' }
                ]
            },
            recommendations: {
                title: 'üí° Recommendations',
                idField: 'rec_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'wellness_tip', label: 'Wellness Tip', type: 'textarea' },
                    { name: 'activity', label: 'Activity', type: 'text' }
                ]
            },
            ai_analysis: {
                title: 'ü§ñ AI Analysis',
                idField: 'analysis_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'risk_score', label: 'Risk Score (0-100)', type: 'number' },
                    { name: 'sentiment_value', label: 'Sentiment Value (-1 to 1)', type: 'number' },
                    { name: 'emotion_label', label: 'Emotion Label', type: 'select', options: ['Anxiety', 'Depression', 'Stress', 'Burnout', 'Stability', 'Optimism', 'Neutral'] }
                ]
            },
            crisisalerts: {
                title: 'üö® Crisis Alerts',
                idField: 'alert_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'risk_level', label: 'Risk Level', type: 'select', options: ['Low', 'Medium', 'High', 'Critical'] },
                    { name: 'alert_timestamp', label: 'Alert Timestamp', type: 'datetime-local' },
                    { name: 'contacted_counsellor_id', label: 'Contacted Counsellor ID', type: 'number' }
                ]
            },
            emergencycontacts: {
                title: 'üìû Emergency Contacts',
                idField: 'contact_id',
                fields: [
                    { name: 'user_id', label: 'User ID', type: 'number', required: true },
                    { name: 'contact_name', label: 'Contact Name', type: 'text', required: true },
                    { name: 'contact_phone', label: 'Contact Phone', type: 'text', required: true },
                    { name: 'relation', label: 'Relation', type: 'text' }
                ]
            }
        };

        // API endpoints
        const apiEndpoints = {
            users: { get: ApiService.getUsers, create: (d) => ApiService.register(d), update: ApiService.updateUser, delete: ApiService.deleteUser },
            dailylogs: { get: ApiService.getDailyLogs, create: ApiService.createDailyLog, update: ApiService.updateDailyLog, delete: ApiService.deleteDailyLog },
            counsellors: { get: ApiService.getCounsellors, create: ApiService.createCounsellor, update: ApiService.updateCounsellor, delete: ApiService.deleteCounsellor },
            sessions: { get: ApiService.getSessions, create: ApiService.createSession, update: ApiService.updateSession, delete: ApiService.deleteSession },
            feedback: { get: ApiService.getFeedback, create: ApiService.createFeedback, update: ApiService.updateFeedback, delete: ApiService.deleteFeedback },
            progress: { get: ApiService.getProgress, create: ApiService.createProgress, update: ApiService.updateProgress, delete: ApiService.deleteProgress },
            recommendations: { get: ApiService.getRecommendations, create: ApiService.createRecommendation, update: ApiService.updateRecommendation, delete: ApiService.deleteRecommendation },
            ai_analysis: { get: ApiService.getAIAnalysis, create: ApiService.createAIAnalysis, update: ApiService.updateAIAnalysis, delete: ApiService.deleteAIAnalysis },
            crisisalerts: { get: ApiService.getCrisisAlerts, create: ApiService.createCrisisAlert, update: ApiService.updateCrisisAlert, delete: ApiService.deleteCrisisAlert },
            emergencycontacts: { get: ApiService.getEmergencyContacts, create: ApiService.createEmergencyContact, update: ApiService.updateEmergencyContact, delete: ApiService.deleteEmergencyContact }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            crudModal = new bootstrap.Modal(document.getElementById('crudModal'));
            setupTabs();
            loadStats();
            loadTableData('users');
        });

        function setupTabs() {
            document.querySelectorAll('.table-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.table-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTable = tab.dataset.table;
                    document.getElementById('tableTitle').textContent = tableSchemas[currentTable].title;
                    loadTableData(currentTable);
                });
            });
        }

        async function loadStats() {
            try {
                const [users, logs, counsellors, sessions, alerts] = await Promise.all([
                    ApiService.getUsers(),
                    ApiService.getDailyLogs(),
                    ApiService.getCounsellors(),
                    ApiService.getSessions(),
                    ApiService.getCrisisAlerts()
                ]);
                document.getElementById('statUsers').textContent = users.length;
                document.getElementById('statLogs').textContent = logs.length;
                document.getElementById('statCounsellors').textContent = counsellors.length;
                document.getElementById('statSessions').textContent = sessions.length;
                document.getElementById('statAlerts').textContent = alerts.length;
            } catch (error) {
                console.error('Stats error:', error);
            }
        }

        async function loadTableData(table) {
            const container = document.getElementById('dataTableContainer');
            container.innerHTML = '<div class="loading-state"><div class="spinner"></div><p>Loading data...</p></div>';

            try {
                currentData = await apiEndpoints[table].get();
                renderTable(currentData, table);
            } catch (error) {
                container.innerHTML = `<div class="error-state">‚ùå Error loading data: ${error.message}<br><small>Make sure XAMPP is running and the API is accessible.</small></div>`;
            }
        }

        // Friendly column name mapping
        const columnLabels = {
            'user_id': 'ID',
            'full_name': 'Full Name',
            'email': 'Email',
            'password': 'Password',
            'phone': 'Phone',
            'gender': 'Gender',
            'date_of_birth': 'Birth Date',
            'designation': 'Role',
            'preferences': 'Preferences',
            'log_id': 'ID',
            'mood_level': 'Mood',
            'stress_level': 'Stress',
            'sleep_hours': 'Sleep (hrs)',
            'notes': 'Notes',
            'log_date': 'Date',
            'counsellor_id': 'ID',
            'name': 'Name',
            'specialization': 'Specialization',
            'schedule': 'Schedule',
            'session_id': 'ID',
            'session_time': 'Date/Time',
            'session_notes': 'Notes',
            'feedback': 'Feedback',
            'feedback_id': 'ID',
            'rating': 'Rating',
            'comments': 'Comments',
            'progress_id': 'ID',
            'emotional_stability_score': 'Stability Score',
            'improvement_percentage': 'Improvement %',
            'trend_notes': 'Trend Notes',
            'rec_id': 'ID',
            'wellness_tip': 'Wellness Tip',
            'activity': 'Activity',
            'analysis_id': 'ID',
            'risk_score': 'Risk Score',
            'sentiment_value': 'Sentiment',
            'emotion_label': 'Emotion',
            'alert_id': 'ID',
            'risk_level': 'Risk Level',
            'alert_timestamp': 'Timestamp',
            'contacted_counsellor_id': 'Counsellor',
            'contact_id': 'ID',
            'contact_name': 'Contact Name',
            'contact_phone': 'Phone',
            'relation': 'Relation',
            'created_at': 'Created'
        };

        function getColumnLabel(col) {
            return columnLabels[col] || col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        function renderTable(data, table) {
            const schema = tableSchemas[table];
            const container = document.getElementById('dataTableContainer');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>No records found</p><p><small>Click "Add New Record" to create one</small></p></div>';
                return;
            }

            const columns = [schema.idField, ...schema.fields.map(f => f.name)];
            let html = '<table class="data-table"><thead><tr>';

            columns.forEach(col => {
                html += `<th>${getColumnLabel(col)}</th>`;
            });
            html += '<th>Actions</th></tr></thead><tbody>';

            data.forEach(row => {
                html += '<tr>';
                columns.forEach(col => {
                    let value = row[col] ?? '-';
                    if (col === 'password') value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    if (col === 'risk_level' || col === 'risk_score') {
                        const riskVal = parseInt(value) || 0;
                        const badgeClass = riskVal > 70 || value === 'Critical' || value === 'High' ? 'badge-high' :
                            riskVal > 40 || value === 'Medium' ? 'badge-medium' : 'badge-low';
                        value = `<span class="data-badge ${badgeClass}">${value}</span>`;
                    }
                    if (typeof value === 'string' && value.length > 40) value = value.substring(0, 40) + '...';
                    html += `<td>${value}</td>`;
                });
                const id = row[schema.idField];
                html += `<td><div class="action-btns">
                    <button class="btn-edit" onclick="openEditModal(${id})">‚úèÔ∏è Edit</button>
                    <button class="btn-delete" onclick="deleteRecord(${id})">üóëÔ∏è Delete</button>
                </div></td></tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = `‚ûï Add ${tableSchemas[currentTable].title}`;
            generateForm();
            crudModal.show();
        }

        function openEditModal(id) {
            editingId = id;
            const record = currentData.find(r => r[tableSchemas[currentTable].idField] === id);
            document.getElementById('modalTitle').textContent = `‚úèÔ∏è Edit ${tableSchemas[currentTable].title}`;
            generateForm(record);
            crudModal.show();
        }

        function generateForm(data = {}) {
            const schema = tableSchemas[currentTable];
            let html = '<div class="row">';

            schema.fields.forEach((field, index) => {
                const value = data[field.name] || '';
                const colClass = field.type === 'textarea' ? 'col-12' : 'col-md-6';

                html += `<div class="${colClass} mb-3">
                    <label class="form-label">${field.label}${field.required ? ' <span style="color:#d32f2f">*</span>' : ''}</label>`;

                if (field.type === 'select') {
                    html += `<select class="form-select" name="${field.name}" ${field.required ? 'required' : ''}>
                        <option value="">Select ${field.label}...</option>`;
                    field.options.forEach(opt => {
                        html += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                    });
                    html += '</select>';
                } else if (field.type === 'textarea') {
                    html += `<textarea class="form-control" name="${field.name}" rows="3" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}...">${value}</textarea>`;
                } else {
                    html += `<input type="${field.type}" class="form-control" name="${field.name}" value="${value}" ${field.required ? 'required' : ''} placeholder="Enter ${field.label.toLowerCase()}...">`;
                }
                html += '</div>';
            });

            html += '</div>';
            document.getElementById('crudForm').innerHTML = html;
        }

        async function saveRecord() {
            const form = document.getElementById('crudForm');
            const formData = new FormData(form);
            const data = {};

            for (let [key, value] of formData.entries()) {
                if (value) data[key] = value;
            }

            try {
                if (editingId) {
                    await apiEndpoints[currentTable].update(editingId, data);
                    showToast('‚úÖ Record updated successfully!', 'success');
                } else {
                    await apiEndpoints[currentTable].create(data);
                    showToast('‚úÖ Record created successfully!', 'success');
                }
                crudModal.hide();
                loadTableData(currentTable);
                loadStats();
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        async function deleteRecord(id) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this record?\n\nThis action cannot be undone.')) return;

            try {
                await apiEndpoints[currentTable].delete(id);
                showToast('‚úÖ Record deleted successfully!', 'success');
                loadTableData(currentTable);
                loadStats();
            } catch (error) {
                showToast('‚ùå Error: ' + error.message, 'error');
            }
        }

        function showToast(message, type) {
            alert(message); // Simple alert for now
        }

        // Mobile menu is handled by theme.js
    </script>
</body>

</html>