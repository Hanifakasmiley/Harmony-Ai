<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature 4 ‚Äì Counsellor Feedback & Progress Tracking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="assets/css/style.css" rel="stylesheet">
</head>

<body>
  <div class="admin-container">
    <aside class="sidebar">
      <h2>üß† Hermony AI</h2>
      <ul>
        <li><a href="index.html">üè† Dashboard</a></li>
        <li><a href="feature1.html">üìã Mood Logging</a></li>
        <li><a href="feature2.html">üë®‚Äç‚öïÔ∏è Counsellors</a></li>
        <li><a href="feature3.html">üßò Recommendations</a></li>
        <li><a href="feature4.html" class="active">‚≠ê Feedback</a></li>
        <li><a href="feature5.html">üìà Progress</a></li>
        <li><a href="feature6.html">üë§ Profiles</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <h2>Counsellor Feedback & Progress Tracking</h2>
      <p>Collect post-session feedback ratings and notes for quality improvement and tracking progress.</p>

      <!-- FEEDBACK FORM SECTION -->
      <section
        style="margin-top: 3rem; background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <h3>Submit Session Feedback</h3>
        <form id="feedbackForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Session ID</label>
              <input type="number" class="form-control" id="feedbackSessionId" placeholder="Enter session ID" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Counsellor ID</label>
              <input type="number" class="form-control" id="feedbackCounsellorId" placeholder="Enter counsellor ID"
                required>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Session Date</label>
              <input type="date" class="form-control" id="feedbackDate" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Overall Rating (1-5 stars)</label>
              <div id="ratingStars" class="rating-stars">
                <span class="star" data-value="1">‚≠ê</span>
                <span class="star" data-value="2">‚≠ê</span>
                <span class="star" data-value="3">‚≠ê</span>
                <span class="star" data-value="4">‚≠ê</span>
                <span class="star" data-value="5">‚≠ê</span>
              </div>
              <input type="hidden" id="feedbackRating" value="0">
              <small class="d-block mt-2 text-muted">Selected: <span id="ratingDisplay">0</span> stars</small>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Feedback & Improvements</label>
            <textarea class="form-control" id="feedbackComments" rows="4"
              placeholder="Share your thoughts on the session, areas of improvement, etc." required></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Session Effectiveness</label>
              <select class="form-control" id="feedbackEffectiveness" required>
                <option value="">-- Select --</option>
                <option value="Very Helpful">Very Helpful</option>
                <option value="Helpful">Helpful</option>
                <option value="Neutral">Neutral</option>
                <option value="Not Helpful">Not Helpful</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Would Recommend?</label>
              <select class="form-control" id="feedbackRecommend" required>
                <option value="">-- Select --</option>
                <option value="Yes">Yes, Highly Recommend</option>
                <option value="Maybe">Maybe</option>
                <option value="No">No</option>
              </select>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">üìù Submit Feedback</button>
          <button type="reset" class="btn btn-secondary">Clear Form</button>
        </form>
      </section>

      <!-- FEEDBACK TABLE SECTION -->
      <section style="margin-top: 3rem;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>All Feedback Records</h3>
          <input type="text" id="searchFeedback" class="form-control w-50"
            placeholder="üîç Search by session ID or counsellor ID">
        </div>

        <div class="table-responsive">
          <table class="table table-hover" id="feedbackTable">
            <thead>
              <tr>
                <th>Feedback ID</th>
                <th>Session ID</th>
                <th>Counsellor ID</th>
                <th>Date</th>
                <th>Rating</th>
                <th>Effectiveness</th>
                <th>Recommend</th>
                <th>Comments</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- PROGRESS TRACKING SECTION -->
      <section
        style="margin-top: 4rem; background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <h3>User Progress Tracking</h3>
        <p class="text-muted">Record improvement metrics, emotional stability scores, and monitor progress trends.</p>

        <form id="progressForm">
          <div class="row">
            <div class="col-md-4 mb-3">
              <label class="form-label">User ID</label>
              <input type="number" class="form-control" id="progressUserId" placeholder="Enter user ID" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Record Date</label>
              <input type="date" class="form-control" id="progressDate" required>
            </div>
            <div class="col-md-4 mb-3">
              <label class="form-label">Progress Category</label>
              <select class="form-control" id="progressCategory" required>
                <option value="">-- Select Category --</option>
                <option value="Mood">Mood</option>
                <option value="Anxiety">Anxiety</option>
                <option value="Stress">Stress</option>
                <option value="Sleep">Sleep Quality</option>
                <option value="Work">Work Performance</option>
                <option value="Relationships">Relationships</option>
                <option value="Overall">Overall Well-being</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Emotional Stability Score (0-100)</label>
              <div class="input-group">
                <input type="range" class="form-range" id="stabilityScore" min="0" max="100" value="50" required>
                <input type="number" class="form-control" id="stabilityScoreDisplay" min="0" max="100" value="50"
                  style="max-width: 80px;">
              </div>
              <small class="d-block mt-1 text-muted">Current: <span id="stabilityValue">50</span>/100</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Improvement Level</label>
              <select class="form-control" id="improvementLevel" required>
                <option value="">-- Select Level --</option>
                <option value="Significant Improvement">Significant Improvement üìà</option>
                <option value="Moderate Improvement">Moderate Improvement üìä</option>
                <option value="Slight Improvement">Slight Improvement üìâ</option>
                <option value="No Change">No Change ‚û°Ô∏è</option>
                <option value="Slight Decline">Slight Decline üìâ</option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Progress Notes & Observations</label>
            <textarea class="form-control" id="progressNotes" rows="4"
              placeholder="Document specific improvements, challenges, and observations..." required></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Areas of Improvement</label>
              <textarea class="form-control" id="improvementAreas" rows="3"
                placeholder="List areas where user has shown improvement..."></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Areas Needing Focus</label>
              <textarea class="form-control" id="focusAreas" rows="3"
                placeholder="Areas that still need attention and work..."></textarea>
            </div>
          </div>

          <button type="submit" class="btn btn-primary">üìä Record Progress</button>
          <button type="reset" class="btn btn-secondary">Clear Form</button>
        </form>
      </section>

      <!-- PROGRESS VISUALIZATION -->
      <section style="margin-top: 3rem;">
        <h3>Progress Trends & Analytics</h3>
        <div class="row">
          <div class="col-md-6">
            <div
              style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
              <canvas id="progressChart" height="80"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div
              style="background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
              <h5>Progress Statistics</h5>
              <div class="progress-stats">
                <div class="stat-item">
                  <span class="stat-label">Total Records</span>
                  <span class="stat-value" id="totalRecords">0</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Average Stability</span>
                  <span class="stat-value" id="avgStability">0</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Latest Score</span>
                  <span class="stat-value" id="latestScore">--</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Trend</span>
                  <span class="stat-value" id="trendIndicator">üìä</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PROGRESS TABLE SECTION -->
      <section style="margin-top: 3rem;">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h3>All Progress Records</h3>
          <input type="text" id="searchProgress" class="form-control w-50"
            placeholder="üîç Search by user ID or category">
        </div>

        <div class="table-responsive">
          <table class="table table-hover" id="progressTable">
            <thead>
              <tr>
                <th>Record ID</th>
                <th>User ID</th>
                <th>Date</th>
                <th>Category</th>
                <th>Stability Score</th>
                <th>Improvement Level</th>
                <th>Notes (Preview)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be populated by JavaScript -->
            </tbody>
          </table>
        </div>
      </section>

      <!-- View Progress Modal -->
      <div class="modal fade" id="viewProgressModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Progress Record Details</h5>
              <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="progressDetailsContent">
              <!-- Content will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- View Feedback Modal -->
  <div class="modal fade" id="viewFeedbackModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Feedback Details</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="feedbackDetailsContent">
          <!-- Content will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    // ===== RATING STARS FUNCTIONALITY =====
    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        const rating = star.getAttribute('data-value');
        document.getElementById('feedbackRating').value = rating;
        document.getElementById('ratingDisplay').textContent = rating;
        document.querySelectorAll('.star').forEach(s => {
          s.style.color = s.getAttribute('data-value') <= rating ? '#FFD700' : '#ccc';
        });
      });

      star.addEventListener('mouseover', () => {
        const hoverRating = star.getAttribute('data-value');
        document.querySelectorAll('.star').forEach(s => {
          s.style.color = s.getAttribute('data-value') <= hoverRating ? '#FFD700' : '#ccc';
        });
      });
    });

    document.getElementById('ratingStars').addEventListener('mouseout', () => {
      const currentRating = document.getElementById('feedbackRating').value;
      document.querySelectorAll('.star').forEach(s => {
        s.style.color = s.getAttribute('data-value') <= currentRating ? '#FFD700' : '#ccc';
      });
    });

    // ===== POPULATE FEEDBACK TABLE =====
    async function populateFeedbackTable() {
      try {
        const feedbacks = await window.DailyDB.getAllFeedback();
        const tbody = document.querySelector('#feedbackTable tbody');
        tbody.innerHTML = '';

        if (feedbacks.length === 0) {
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No feedback records yet</td></tr>';
          return;
        }

        feedbacks.forEach(feedback => {
          const row = document.createElement('tr');
          row.innerHTML = `
        <td><strong>${feedback.id}</strong></td>
        <td>${feedback.sessionId}</td>
        <td>${feedback.counsellorId}</td>
        <td>${feedback.date}</td>
        <td><span class="badge bg-warning text-dark">${feedback.rating}‚≠ê</span></td>
        <td>${feedback.effectiveness}</td>
        <td>${feedback.recommend}</td>
        <td><small>${feedback.comments.substring(0, 30)}...</small></td>
        <td>
          <button class="btn btn-sm btn-info viewFeedbackBtn" data-id="${feedback.id}">üëÅÔ∏è View</button>
          <button class="btn btn-sm btn-danger deleteFeedbackBtn" data-id="${feedback.id}">üóëÔ∏è Delete</button>
        </td>
      `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading feedback:', err);
      }
    }

    // ===== SUBMIT FEEDBACK FORM =====
    document.getElementById('feedbackForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const feedback = {
        sessionId: parseInt(document.getElementById('feedbackSessionId').value),
        counsellorId: parseInt(document.getElementById('feedbackCounsellorId').value),
        date: document.getElementById('feedbackDate').value,
        rating: parseInt(document.getElementById('feedbackRating').value),
        effectiveness: document.getElementById('feedbackEffectiveness').value,
        recommend: document.getElementById('feedbackRecommend').value,
        comments: document.getElementById('feedbackComments').value,
        timestamp: new Date().toISOString()
      };

      try {
        await window.DailyDB.addFeedback(feedback);
        alert('‚úÖ Feedback submitted successfully!');
        document.getElementById('feedbackForm').reset();
        document.getElementById('feedbackRating').value = 0;
        document.getElementById('ratingDisplay').textContent = '0';
        document.querySelectorAll('.star').forEach(s => s.style.color = '#ccc');
        await populateFeedbackTable();
      } catch (err) {
        alert('‚ùå Error submitting feedback: ' + err.message);
      }
    });

    // ===== VIEW FEEDBACK =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('viewFeedbackBtn')) {
        const feedbackId = e.target.getAttribute('data-id');
        const feedbacks = await window.DailyDB.getAllFeedback();
        const feedback = feedbacks.find(f => f.id === parseInt(feedbackId));

        if (feedback) {
          const content = `
        <p><strong>Feedback ID:</strong> ${feedback.id}</p>
        <p><strong>Session ID:</strong> ${feedback.sessionId}</p>
        <p><strong>Counsellor ID:</strong> ${feedback.counsellorId}</p>
        <p><strong>Date:</strong> ${feedback.date}</p>
        <p><strong>Overall Rating:</strong> <span class="badge bg-warning text-dark">${feedback.rating} ‚≠ê</span></p>
        <p><strong>Session Effectiveness:</strong> ${feedback.effectiveness}</p>
        <p><strong>Would Recommend:</strong> ${feedback.recommend}</p>
        <p><strong>Feedback & Comments:</strong></p>
        <div class="alert alert-info">${feedback.comments}</div>
        <p><strong>Submitted At:</strong> ${new Date(feedback.timestamp).toLocaleString()}</p>
      `;
          document.getElementById('feedbackDetailsContent').innerHTML = content;
          const modal = new bootstrap.Modal(document.getElementById('viewFeedbackModal'));
          modal.show();
        }
      }
    });

    // ===== DELETE FEEDBACK =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('deleteFeedbackBtn')) {
        const feedbackId = e.target.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this feedback?')) {
          try {
            await window.DailyDB.deleteFeedback(feedbackId);
            alert('‚úÖ Feedback deleted successfully!');
            await populateFeedbackTable();
          } catch (err) {
            alert('‚ùå Error deleting feedback: ' + err.message);
          }
        }
      }
    });

    // ===== SEARCH FEEDBACK =====
    document.getElementById('searchFeedback').addEventListener('keyup', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('#feedbackTable tbody tr').forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      });
    });

    // ===== INITIALIZE =====
    document.addEventListener('DOMContentLoaded', async () => {
      await populateFeedbackTable();
      await populateProgressTable();
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('feedbackDate').value = today;
      document.getElementById('progressDate').value = today;
      // Initialize progress chart
      await initializeProgressChart();
      await updateProgressStats();
    });

    // ===== STABILITY SCORE SYNC =====
    document.getElementById('stabilityScore').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('stabilityScoreDisplay').value = value;
      document.getElementById('stabilityValue').textContent = value;
    });

    document.getElementById('stabilityScoreDisplay').addEventListener('input', (e) => {
      const value = Math.max(0, Math.min(100, e.target.value));
      document.getElementById('stabilityScore').value = value;
      document.getElementById('stabilityValue').textContent = value;
    });

    // ===== PROGRESS FORM SUBMISSION =====
    document.getElementById('progressForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const progress = {
        userId: parseInt(document.getElementById('progressUserId').value),
        date: document.getElementById('progressDate').value,
        category: document.getElementById('progressCategory').value,
        stabilityScore: parseInt(document.getElementById('stabilityScore').value),
        improvementLevel: document.getElementById('improvementLevel').value,
        notes: document.getElementById('progressNotes').value,
        improvementAreas: document.getElementById('improvementAreas').value,
        focusAreas: document.getElementById('focusAreas').value,
        timestamp: new Date().toISOString()
      };

      try {
        await window.DailyDB.addProgress(progress);
        alert('‚úÖ Progress record added successfully!');
        document.getElementById('progressForm').reset();
        document.getElementById('stabilityScore').value = 50;
        document.getElementById('stabilityScoreDisplay').value = 50;
        document.getElementById('stabilityValue').textContent = 50;
        await populateProgressTable();
        await updateProgressStats();
        await initializeProgressChart();
      } catch (err) {
        alert('‚ùå Error recording progress: ' + err.message);
      }
    });

    // ===== POPULATE PROGRESS TABLE =====
    async function populateProgressTable() {
      try {
        const progressRecords = await window.DailyDB.getAllProgress();
        const tbody = document.querySelector('#progressTable tbody');
        tbody.innerHTML = '';

        if (progressRecords.length === 0) {
          tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No progress records yet</td></tr>';
          return;
        }

        // Sort by date descending (newest first)
        progressRecords.sort((a, b) => new Date(b.date) - new Date(a.date));

        progressRecords.forEach(progress => {
          const row = document.createElement('tr');
          const improvementEmoji = {
            'Significant Improvement': 'üìà',
            'Moderate Improvement': 'üìä',
            'Slight Improvement': 'üìâ',
            'No Change': '‚û°Ô∏è',
            'Slight Decline': 'üìâ'
          }[progress.improvementLevel] || 'üìä';

          row.innerHTML = `
            <td><strong>${progress.id}</strong></td>
            <td>${progress.userId}</td>
            <td>${progress.date}</td>
            <td><span class="badge bg-info">${progress.category}</span></td>
            <td><span class="badge bg-success">${progress.stabilityScore}/100</span></td>
            <td>${improvementEmoji} ${progress.improvementLevel}</td>
            <td><small>${progress.notes.substring(0, 30)}...</small></td>
            <td>
              <button class="btn btn-sm btn-info viewProgressBtn" data-id="${progress.id}">üëÅÔ∏è View</button>
              <button class="btn btn-sm btn-danger deleteProgressBtn" data-id="${progress.id}">üóëÔ∏è Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error('Error loading progress records:', err);
      }
    }

    // ===== VIEW PROGRESS =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('viewProgressBtn')) {
        const progressId = e.target.getAttribute('data-id');
        const progressRecords = await window.DailyDB.getAllProgress();
        const progress = progressRecords.find(p => p.id === parseInt(progressId));

        if (progress) {
          const content = `
            <p><strong>Record ID:</strong> ${progress.id}</p>
            <p><strong>User ID:</strong> ${progress.userId}</p>
            <p><strong>Date:</strong> ${progress.date}</p>
            <p><strong>Category:</strong> <span class="badge bg-info">${progress.category}</span></p>
            <p><strong>Emotional Stability Score:</strong> <span class="badge bg-success">${progress.stabilityScore}/100</span></p>
            <div class="progress mb-3">
              <div class="progress-bar" style="width: ${progress.stabilityScore}%"></div>
            </div>
            <p><strong>Improvement Level:</strong> ${progress.improvementLevel}</p>
            <p><strong>Progress Notes:</strong></p>
            <div class="alert alert-info">${progress.notes}</div>
            <p><strong>Areas of Improvement:</strong></p>
            <div class="alert alert-success">${progress.improvementAreas || 'Not specified'}</div>
            <p><strong>Areas Needing Focus:</strong></p>
            <div class="alert alert-warning">${progress.focusAreas || 'Not specified'}</div>
            <p><strong>Recorded At:</strong> ${new Date(progress.timestamp).toLocaleString()}</p>
          `;
          document.getElementById('progressDetailsContent').innerHTML = content;
          const modal = new bootstrap.Modal(document.getElementById('viewProgressModal'));
          modal.show();
        }
      }
    });

    // ===== DELETE PROGRESS =====
    document.addEventListener('click', async (e) => {
      if (e.target.classList.contains('deleteProgressBtn')) {
        const progressId = e.target.getAttribute('data-id');
        if (confirm('Are you sure you want to delete this progress record?')) {
          try {
            await window.DailyDB.deleteProgress(progressId);
            alert('‚úÖ Progress record deleted successfully!');
            await populateProgressTable();
            await updateProgressStats();
            await initializeProgressChart();
          } catch (err) {
            alert('‚ùå Error deleting progress record: ' + err.message);
          }
        }
      }
    });

    // ===== SEARCH PROGRESS =====
    document.getElementById('searchProgress').addEventListener('keyup', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      document.querySelectorAll('#progressTable tbody tr').forEach(row => {
        const rowText = row.innerText.toLowerCase();
        row.style.display = rowText.includes(searchTerm) ? '' : 'none';
      });
    });

    // ===== PROGRESS CHART INITIALIZATION =====
    let progressChartInstance = null;

    async function initializeProgressChart() {
      try {
        const progressRecords = await window.DailyDB.getAllProgress();

        if (progressRecords.length === 0) {
          const ctx = document.getElementById('progressChart').getContext('2d');
          if (progressChartInstance) progressChartInstance.destroy();
          progressChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
              labels: [],
              datasets: []
            },
            options: {
              responsive: true,
              plugins: {
                title: {
                  display: true,
                  text: 'No progress data to display'
                }
              }
            }
          });
          return;
        }

        // Sort by date
        progressRecords.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Group by category
        const categories = {};
        progressRecords.forEach(record => {
          if (!categories[record.category]) {
            categories[record.category] = [];
          }
          categories[record.category].push(record);
        });

        // Prepare datasets
        const datasets = [];
        const colors = ['#667eea', '#764ba2', '#1abc9c', '#f39c12', '#e74c3c', '#3498db', '#2ecc71'];
        let colorIndex = 0;

        const allDates = [...new Set(progressRecords.map(r => r.date))].sort();

        Object.keys(categories).forEach(category => {
          const categoryData = categories[category];
          const data = allDates.map(date => {
            const record = categoryData.find(r => r.date === date);
            return record ? record.stabilityScore : null;
          });

          datasets.push({
            label: category,
            data: data,
            borderColor: colors[colorIndex % colors.length],
            backgroundColor: colors[colorIndex % colors.length] + '20',
            tension: 0.4,
            fill: true
          });
          colorIndex++;
        });

        const ctx = document.getElementById('progressChart').getContext('2d');
        if (progressChartInstance) progressChartInstance.destroy();

        progressChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: allDates,
            datasets: datasets
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: 'Emotional Stability Score Trends',
                font: {
                  size: 14,
                  weight: 'bold'
                }
              },
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + ' pts';
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error('Error initializing progress chart:', err);
      }
    }

    // ===== UPDATE PROGRESS STATISTICS =====
    async function updateProgressStats() {
      try {
        const progressRecords = await window.DailyDB.getAllProgress();

        if (progressRecords.length === 0) {
          document.getElementById('totalRecords').textContent = '0';
          document.getElementById('avgStability').textContent = '0';
          document.getElementById('latestScore').textContent = '--';
          document.getElementById('trendIndicator').textContent = 'üìä';
          return;
        }

        // Total records
        document.getElementById('totalRecords').textContent = progressRecords.length;

        // Average stability score
        const avgScore = Math.round(
          progressRecords.reduce((sum, r) => sum + r.stabilityScore, 0) / progressRecords.length
        );
        document.getElementById('avgStability').textContent = avgScore;

        // Latest score
        const sorted = [...progressRecords].sort((a, b) => new Date(b.date) - new Date(a.date));
        document.getElementById('latestScore').textContent = sorted[0].stabilityScore;

        // Trend indicator
        if (progressRecords.length >= 2) {
          const latest = sorted[0].stabilityScore;
          const previous = sorted[1].stabilityScore;
          let trendEmoji = '‚û°Ô∏è';
          if (latest > previous + 5) trendEmoji = 'üìà Improving';
          else if (latest < previous - 5) trendEmoji = 'üìâ Declining';
          else trendEmoji = '‚û°Ô∏è Stable';
          document.getElementById('trendIndicator').textContent = trendEmoji;
        }
      } catch (err) {
        console.error('Error updating progress stats:', err);
      }
    }
  </script>
</body>

</html>