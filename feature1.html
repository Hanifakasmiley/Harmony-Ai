<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature 1 - Daily Mood & Stress Logging</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!-- Top Navigation -->
  <nav class="top-navbar">
    <div class="nav-container">
      <a href="./index.html" class="nav-logo">ğŸ§  Hermony AI</a>
      <ul class="nav-menu">
        <li><a href="./index.html">ğŸ  Dashboard</a></li>
        <li><a href="./feature1.html">ğŸ“‹ Mood Logging</a></li>
        <li><a href="./feature2.html">ğŸ‘¨â€âš•ï¸ Counsellors</a></li>
        <li><a href="./feature3.html">ğŸ§˜ Recommendations</a></li>
        <li><a href="./feature4.html">â­ Feedback</a></li>
        <li><a href="./feature5.html">ğŸ¤– AI Analysis</a></li>
        <li><a href="./feature6.html">ğŸ‘¤ Profiles</a></li>
      </ul>
      <div class="nav-actions">
        <button class="mobile-menu-btn" aria-label="Toggle menu" title="Open navigation">
          <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"
            focusable="false">
            <rect x="3" y="6" width="18" height="2" rx="1" fill="currentColor" />
            <rect x="3" y="11" width="18" height="2" rx="1" fill="currentColor" />
            <rect x="3" y="16" width="18" height="2" rx="1" fill="currentColor" />
          </svg>
        </button>
        <button class="theme-toggle" title="Toggle dark mode">ğŸŒ™</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <h2 id="pageTitle">Feature 1: Daily Mood & Stress Logging</h2>
      <div
        style="font-size: 0.9rem; color: var(--text-secondary); background: var(--bg-tertiary); padding: 0.5rem 1rem; border-radius: 8px;">
        Role: <strong id="userRole">Patient</strong>
      </div>
    </div>
    <p id="pageDesc">Manage and monitor user mood data below.</p>

    <!-- Role-Specific Data Display -->
    <div id="roleDataSection" style="display: none; margin-bottom: 2rem;">
      <div
        style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border-left: 4px solid var(--primary-color);">
        <h3 style="margin-top: 0;">Dashboard Overview</h3>
        <div id="roleDataContent"></div>
      </div>
    </div>

    <!-- TEST SECTION - Demo Data Buttons -->
    <div
      style="margin-top: 3rem; padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
      <h4 style="color: white; margin-top: 0; margin-bottom: 1rem;">ğŸ§ª View Role-Based Data (20 Patients)</h4>
      <p style="color: rgba(255,255,255,0.9); margin-bottom: 1.5rem;">Click a role below to see all patient data for
        that designation:</p>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.7rem;">
        <button class="btn btn-light btn-sm" onclick="window.testData('software_engineer')" style="font-weight: 600;">ğŸ“Š
          Software Engineer</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('ai_engineer')" style="font-weight: 600;">ğŸ¤– AI
          Engineer</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('data_scientist')" style="font-weight: 600;">ğŸ“ˆ
          Data Scientist</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('mental_health_admin')"
          style="font-weight: 600;">ğŸ¥ Health Admin</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('emergency_team')" style="font-weight: 600;">ğŸš¨
          Emergency Team</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('security_analyst')" style="font-weight: 600;">ğŸ”’
          Security</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('financial_team')" style="font-weight: 600;">ğŸ’°
          Financial</button>
        <button class="btn btn-light btn-sm" onclick="window.testData('system_admin')" style="font-weight: 600;">âš™ï¸
          System Admin</button>
      </div>
    </div>

    <h2>Feature 1: Daily Mood & Stress Logging</h2>
    <p>Manage and monitor user mood data below.</p>

    <!-- ===== USER PROFILES SECTION ===== -->
    <section class="mt-5 mb-5">
      <h3>ğŸ‘¤ User Profiles</h3>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <input type="text" id="searchUsers" class="form-control w-50" placeholder="ğŸ” Search by user ID or name...">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">â• Add User
          Profile</button>
      </div>

      <table class="table table-hover mt-4" id="usersTable">
        <thead class="table-dark">
          <tr>
            <th>User ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Preferences</th>
            <th>Emergency Contact</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- populated from IndexedDB -->
        </tbody>
      </table>
    </section>

    <!-- Search + Add Mood -->
    <div class="d-flex justify-content-between align-items-center mt-3">
      <input type="text" id="searchInput" class="form-control w-50" placeholder="ğŸ” Search by user or mood...">
      <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">â• Add Record</button>
    </div>

    <!-- Table -->
    <table class="table table-hover mt-4" id="moodTable">
      <thead class="table-dark">
        <tr>
          <th>User ID</th>
          <th>Mood</th>
          <th>Stress</th>
          <th>Sleep (hrs)</th>
          <th>Notes</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- rows populated from IndexedDB -->
      </tbody>
    </table>

    <!-- Chart -->
    <h3 class="mt-4">Mood Trend Overview</h3>
    <canvas id="moodChart" height="120"></canvas>
    </main>
  </div>

  <!-- Add User Profile Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add User Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="userProfileId" class="form-control mb-2" placeholder="User ID">
          <input type="text" id="userProfileName" class="form-control mb-2" placeholder="Full Name">
          <input type="email" id="userProfileEmail" class="form-control mb-2" placeholder="Email">
          <input type="text" id="userProfilePhone" class="form-control mb-2" placeholder="Phone Number">
          <textarea id="userProfilePreferences" class="form-control mb-2"
            placeholder="Preferences (e.g., Notification settings, Language)"></textarea>
          <textarea id="userProfileEmergency" class="form-control mb-2"
            placeholder="Emergency Contact (name, phone, relationship)"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveUserProfile">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Mood Record Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="userId" class="form-control mb-2" placeholder="User ID">
          <input type="text" id="mood" class="form-control mb-2" placeholder="Mood">
          <input type="text" id="stress" class="form-control mb-2" placeholder="Stress Level">
          <input type="number" id="sleep" class="form-control mb-2" placeholder="Sleep Hours">
          <textarea id="notes" class="form-control mb-2" placeholder="Notes"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="saveRecord">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/charts.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    // === SEARCH FUNCTION ===
    document.getElementById('searchInput').addEventListener('keyup', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#moodTable tbody tr');
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Populate table from DB
    async function populateTable() {
      const tbody = document.querySelector('#moodTable tbody');
      tbody.innerHTML = '';
      try {
        const logs = await window.DailyDB.getAllLogs();
        // sort by date desc (if date stored)
        logs.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        for (const item of logs) {
          const tr = document.createElement('tr');
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td>${item.userId || ''}</td>
            <td>${item.mood || ''}</td>
            <td>${item.stress || ''}</td>
            <td>${item.sleep != null ? item.sleep : ''}</td>
            <td>${item.notes || ''}</td>
            <td>
              <button class="btn btn-sm btn-info viewBtn">View</button>
              <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error('Failed to load logs', err);
      }
    }

    // Initialize DB and populate
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.DailyDB && window.DailyDB.init) {
        await window.DailyDB.init();
        populateTable();
        populateUsersTable();
      } else {
        console.warn('DailyDB not available');
      }
    });

    // ===== USER PROFILES SECTION =====
    async function populateUsersTable() {
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      try {
        const users = await window.DailyDB.getAllUsers();
        for (const item of users) {
          const tr = document.createElement('tr');
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td>${item.userId || ''}</td>
            <td>${item.name || ''}</td>
            <td>${item.email || ''}</td>
            <td>${item.phone || ''}</td>
            <td>${item.preferences || ''}</td>
            <td>${item.emergencyContact || ''}</td>
            <td>
              <button class="btn btn-sm btn-info viewUserBtn">View</button>
              <button class="btn btn-sm btn-warning editUserBtn">Edit</button>
              <button class="btn btn-sm btn-danger deleteUserBtn">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error('Failed to load users', err);
      }
    }

    // Search Users
    document.getElementById('searchUsers').addEventListener('keyup', function () {
      const filter = this.value.toLowerCase();
      document.querySelectorAll('#usersTable tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Save User Profile
    document.getElementById('saveUserProfile').addEventListener('click', async function () {
      const userId = document.getElementById('userProfileId').value.trim();
      const name = document.getElementById('userProfileName').value.trim();
      const email = document.getElementById('userProfileEmail').value.trim();
      const phone = document.getElementById('userProfilePhone').value.trim();
      const preferences = document.getElementById('userProfilePreferences').value.trim();
      const emergencyContact = document.getElementById('userProfileEmergency').value.trim();

      if (!userId || !name) return alert('Please fill User ID and Name');

      const entry = { userId, name, email, phone, preferences, emergencyContact };
      try {
        await window.DailyDB.addUser(entry);
        populateUsersTable();
        ['userProfileId', 'userProfileName', 'userProfileEmail', 'userProfilePhone', 'userProfilePreferences', 'userProfileEmergency'].forEach(id =>
          document.getElementById(id).value = ''
        );
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
      } catch (err) {
        console.error('Failed to save user', err);
        alert('Failed to save profile');
      }
    });

    // Delete / View User
    document.addEventListener('click', async e => {
      if (e.target.classList.contains('deleteUserBtn')) {
        if (!confirm('Delete this user profile?')) return;
        const id = e.target.closest('tr').dataset.id;
        try {
          await window.DailyDB.deleteUser(id);
          populateUsersTable();
        } catch (err) {
          console.error('Failed to delete', err);
        }
      }
      if (e.target.classList.contains('viewUserBtn')) {
        alert('View User:\n' + e.target.closest('tr').innerText);
      }
      if (e.target.classList.contains('editUserBtn')) {
        alert('Edit feature coming soon');
      }
    });

    // === ADD RECORD ===
    document.getElementById('saveRecord').addEventListener('click', async function () {
      const id = document.getElementById('userId').value.trim();
      const mood = document.getElementById('mood').value.trim();
      const stress = document.getElementById('stress').value.trim();
      const sleep = document.getElementById('sleep').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!id || !mood) return alert('Please fill User ID and Mood');

      const entry = {
        date: new Date().toISOString().split('T')[0],
        userId: id,
        mood,
        stress,
        sleep: sleep === '' ? null : Number(sleep),
        notes
      };

      try {
        await window.DailyDB.addLog(entry);
        populateTable();
        // clear inputs
        ['userId', 'mood', 'stress', 'sleep', 'notes'].forEach(id => document.getElementById(id).value = '');
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
      } catch (err) {
        console.error('Failed to save log', err);
        alert('Failed to save record. See console.');
      }
    });

    // === VIEW / DELETE Buttons ===
    document.addEventListener('click', async e => {
      if (e.target.classList.contains('viewBtn')) {
        const tr = e.target.closest('tr');
        alert('View Record:\n' + tr.innerText);
      }
      if (e.target.classList.contains('deleteBtn')) {
        if (!confirm('Delete this record?')) return;
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        try {
          await window.DailyDB.deleteLog(id);
          populateTable();
        } catch (err) {
          console.error('Failed to delete', err);
          alert('Delete failed');
        }
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Database & Seed Data -->
  <script src="assets/js/db-crud-operations.js"></script>
  <script src="assets/js/comprehensive-seed-data.js"></script>
  <script src="assets/js/dummy-data.js"></script>
  <!-- Designation-Specific Tables -->
  <script src="assets/js/designation-features-mapping.js"></script>
  <script src="assets/js/designation-data-tables.js"></script>
  <script>
    // Display role-specific data on page load
    async function displayRoleData() {
      const userRole = localStorage.getItem('userRole') || 'patient';
      const designation = localStorage.getItem('designation') || 'Patient/User';

      console.log('ğŸ” displayRoleData called - Role:', userRole, 'Designation:', designation);
      console.log('âœ… DummyData available:', !!window.DummyData);
      console.log('âœ… DesignationDataTables available:', !!window.DesignationDataTables);

      document.getElementById('userRole').textContent = designation;
      document.getElementById('pageTitle').textContent = `ğŸ§  Harmonyai - ${designation}`;
      document.getElementById('pageDesc').textContent = `Welcome, ${designation}. Viewing role-specific patient data and analytics.`;

      if (userRole === 'patient') {
        console.log('ğŸ‘¤ User is patient - skipping role data display');
        return;
      }

      const roleDataSection = document.getElementById('roleDataSection');
      const roleDataContent = document.getElementById('roleDataContent');
      roleDataSection.style.display = 'block';

      try {
        let html = '<h3 style="margin-bottom: 2rem; color: #333;">ğŸ“Š Patient Data - Excel-Style Tables</h3>';

        if (userRole === 'software_engineer') {
          console.log('ğŸ“Š Generating Software Engineer table...');
          html += await window.DesignationDataTables.getSoftwareEngineerTable();
        } else if (userRole === 'ai_engineer') {
          console.log('ğŸ¤– Generating AI Engineer table...');
          html += await window.DesignationDataTables.getAIEngineerTable();
        } else if (userRole === 'data_scientist') {
          console.log('ğŸ“ˆ Generating Data Scientist table...');
          html += await window.DesignationDataTables.getDataScientistTable();
        } else if (userRole === 'mental_health_admin') {
          console.log('ğŸ¥ Generating Mental Health Admin table...');
          html += await window.DesignationDataTables.getMentalHealthAdminTable();
        } else if (userRole === 'emergency_team') {
          console.log('ğŸš¨ Generating Emergency Team table...');
          html += await window.DesignationDataTables.getEmergencyTeamTable();
        } else if (userRole === 'security_analyst') {
          console.log('ğŸ”’ Generating Security Analyst table...');
          html += await window.DesignationDataTables.getSecurityAnalystTable();
        } else if (userRole === 'financial_team') {
          console.log('ğŸ’° Generating Financial Team table...');
          html += await window.DesignationDataTables.getFinancialTeamTable();
        } else if (userRole === 'system_admin') {
          console.log('âš™ï¸ Generating System Admin table...');
          html += await window.DesignationDataTables.getSystemAdminTable();
        }

        console.log('âœ… Table generated, updating content...');
        roleDataContent.innerHTML = html;
        console.log('âœ… Table displayed successfully!');
      } catch (error) {
        console.error('âŒ Error displaying role data:', error);
        console.error('Error stack:', error.stack);
        roleDataContent.innerHTML = '<p style="color: red;">Error loading data: ' + error.message + '</p>';
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      console.log('ğŸ“„ Page loaded, calling displayRoleData after 500ms delay...');
      setTimeout(displayRoleData, 500);

      // Add test helper function to window for debugging
      window.testData = async function (role) {
        console.log('ğŸ§ª Testing role:', role);
        localStorage.setItem('userRole', role);
        localStorage.setItem('designation', role.replace(/_/g, ' ').toUpperCase());
        await displayRoleData();
      };
    });
  </script>
  <script src="assets/js/theme.js"></script>
</body>

</html>