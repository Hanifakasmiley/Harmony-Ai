<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feature 1 - Daily Mood & Stress Logging</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/css/style.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <div class="admin-container">
    <aside class="sidebar">
      <h2>AI Mental Health</h2>
      <ul>
        <li><a href="index.html">üè† Dashboard</a></li>
        <li><a href="feature2.html">üß† AI Mood Analysis</a></li>
      </ul>
    </aside>

    <main class="main-content">
      <h2>Feature 1: Daily Mood & Stress Logging</h2>
      <p>Manage and monitor user mood data below.</p>

      <!-- ===== USER PROFILES SECTION ===== -->
      <section class="mt-5 mb-5">
        <h3>üë§ User Profiles</h3>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <input type="text" id="searchUsers" class="form-control w-50" placeholder="üîç Search by user ID or name...">
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">‚ûï Add User
            Profile</button>
        </div>

        <table class="table table-hover mt-4" id="usersTable">
          <thead class="table-dark">
            <tr>
              <th>User ID</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Preferences</th>
              <th>Emergency Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- populated from IndexedDB -->
          </tbody>
        </table>
      </section>

      <!-- Search + Add Mood -->
      <div class="d-flex justify-content-between align-items-center mt-3">
        <input type="text" id="searchInput" class="form-control w-50" placeholder="üîç Search by user or mood...">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addModal">‚ûï Add Record</button>
      </div>

      <!-- Table -->
      <table class="table table-hover mt-4" id="moodTable">
        <thead class="table-dark">
          <tr>
            <th>User ID</th>
            <th>Mood</th>
            <th>Stress</th>
            <th>Sleep (hrs)</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- rows populated from IndexedDB -->
        </tbody>
      </table>

      <!-- Chart -->
      <h3 class="mt-4">Mood Trend Overview</h3>
      <canvas id="moodChart" height="120"></canvas>
    </main>
  </div>

  <!-- Add User Profile Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add User Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="userProfileId" class="form-control mb-2" placeholder="User ID">
          <input type="text" id="userProfileName" class="form-control mb-2" placeholder="Full Name">
          <input type="email" id="userProfileEmail" class="form-control mb-2" placeholder="Email">
          <input type="text" id="userProfilePhone" class="form-control mb-2" placeholder="Phone Number">
          <textarea id="userProfilePreferences" class="form-control mb-2"
            placeholder="Preferences (e.g., Notification settings, Language)"></textarea>
          <textarea id="userProfileEmergency" class="form-control mb-2"
            placeholder="Emergency Contact (name, phone, relationship)"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-primary" id="saveUserProfile">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Mood Record Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Record</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="userId" class="form-control mb-2" placeholder="User ID">
          <input type="text" id="mood" class="form-control mb-2" placeholder="Mood">
          <input type="text" id="stress" class="form-control mb-2" placeholder="Stress Level">
          <input type="number" id="sleep" class="form-control mb-2" placeholder="Sleep Hours">
          <textarea id="notes" class="form-control mb-2" placeholder="Notes"></textarea>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="saveRecord">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/charts.js"></script>
  <script src="assets/js/main.js"></script>

  <script>
    // === SEARCH FUNCTION ===
    document.getElementById('searchInput').addEventListener('keyup', function () {
      const filter = this.value.toLowerCase();
      const rows = document.querySelectorAll('#moodTable tbody tr');
      rows.forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Populate table from DB
    async function populateTable() {
      const tbody = document.querySelector('#moodTable tbody');
      tbody.innerHTML = '';
      try {
        const logs = await window.DailyDB.getAllLogs();
        // sort by date desc (if date stored)
        logs.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
        for (const item of logs) {
          const tr = document.createElement('tr');
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td>${item.userId || ''}</td>
            <td>${item.mood || ''}</td>
            <td>${item.stress || ''}</td>
            <td>${item.sleep != null ? item.sleep : ''}</td>
            <td>${item.notes || ''}</td>
            <td>
              <button class="btn btn-sm btn-info viewBtn">View</button>
              <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error('Failed to load logs', err);
      }
    }

    // Initialize DB and populate
    document.addEventListener('DOMContentLoaded', async () => {
      if (window.DailyDB && window.DailyDB.init) {
        await window.DailyDB.init();
        populateTable();
        populateUsersTable();
      } else {
        console.warn('DailyDB not available');
      }
    });

    // ===== USER PROFILES SECTION =====
    async function populateUsersTable() {
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      try {
        const users = await window.DailyDB.getAllUsers();
        for (const item of users) {
          const tr = document.createElement('tr');
          tr.dataset.id = item.id;
          tr.innerHTML = `
            <td>${item.userId || ''}</td>
            <td>${item.name || ''}</td>
            <td>${item.email || ''}</td>
            <td>${item.phone || ''}</td>
            <td>${item.preferences || ''}</td>
            <td>${item.emergencyContact || ''}</td>
            <td>
              <button class="btn btn-sm btn-info viewUserBtn">View</button>
              <button class="btn btn-sm btn-warning editUserBtn">Edit</button>
              <button class="btn btn-sm btn-danger deleteUserBtn">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error('Failed to load users', err);
      }
    }

    // Search Users
    document.getElementById('searchUsers').addEventListener('keyup', function () {
      const filter = this.value.toLowerCase();
      document.querySelectorAll('#usersTable tbody tr').forEach(row => {
        row.style.display = row.innerText.toLowerCase().includes(filter) ? '' : 'none';
      });
    });

    // Save User Profile
    document.getElementById('saveUserProfile').addEventListener('click', async function () {
      const userId = document.getElementById('userProfileId').value.trim();
      const name = document.getElementById('userProfileName').value.trim();
      const email = document.getElementById('userProfileEmail').value.trim();
      const phone = document.getElementById('userProfilePhone').value.trim();
      const preferences = document.getElementById('userProfilePreferences').value.trim();
      const emergencyContact = document.getElementById('userProfileEmergency').value.trim();

      if (!userId || !name) return alert('Please fill User ID and Name');

      const entry = { userId, name, email, phone, preferences, emergencyContact };
      try {
        await window.DailyDB.addUser(entry);
        populateUsersTable();
        ['userProfileId', 'userProfileName', 'userProfileEmail', 'userProfilePhone', 'userProfilePreferences', 'userProfileEmergency'].forEach(id =>
          document.getElementById(id).value = ''
        );
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
      } catch (err) {
        console.error('Failed to save user', err);
        alert('Failed to save profile');
      }
    });

    // Delete / View User
    document.addEventListener('click', async e => {
      if (e.target.classList.contains('deleteUserBtn')) {
        if (!confirm('Delete this user profile?')) return;
        const id = e.target.closest('tr').dataset.id;
        try {
          await window.DailyDB.deleteUser(id);
          populateUsersTable();
        } catch (err) {
          console.error('Failed to delete', err);
        }
      }
      if (e.target.classList.contains('viewUserBtn')) {
        alert('View User:\n' + e.target.closest('tr').innerText);
      }
      if (e.target.classList.contains('editUserBtn')) {
        alert('Edit feature coming soon');
      }
    });

    // === ADD RECORD ===
    document.getElementById('saveRecord').addEventListener('click', async function () {
      const id = document.getElementById('userId').value.trim();
      const mood = document.getElementById('mood').value.trim();
      const stress = document.getElementById('stress').value.trim();
      const sleep = document.getElementById('sleep').value.trim();
      const notes = document.getElementById('notes').value.trim();

      if (!id || !mood) return alert('Please fill User ID and Mood');

      const entry = {
        date: new Date().toISOString().split('T')[0],
        userId: id,
        mood,
        stress,
        sleep: sleep === '' ? null : Number(sleep),
        notes
      };

      try {
        await window.DailyDB.addLog(entry);
        populateTable();
        // clear inputs
        ['userId', 'mood', 'stress', 'sleep', 'notes'].forEach(id => document.getElementById(id).value = '');
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
      } catch (err) {
        console.error('Failed to save log', err);
        alert('Failed to save record. See console.');
      }
    });

    // === VIEW / DELETE Buttons ===
    document.addEventListener('click', async e => {
      if (e.target.classList.contains('viewBtn')) {
        const tr = e.target.closest('tr');
        alert('View Record:\n' + tr.innerText);
      }
      if (e.target.classList.contains('deleteBtn')) {
        if (!confirm('Delete this record?')) return;
        const tr = e.target.closest('tr');
        const id = tr.dataset.id;
        try {
          await window.DailyDB.deleteLog(id);
          populateTable();
        } catch (err) {
          console.error('Failed to delete', err);
          alert('Delete failed');
        }
      }
    });
  </script>
</body>

</html>